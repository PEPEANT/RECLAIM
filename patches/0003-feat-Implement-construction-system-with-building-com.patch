From b151fe40bf5c5603b875bf73bee5e87fc033e5e2 Mon Sep 17 00:00:00 2001
From: Claude <noreply@anthropic.com>
Date: Thu, 15 Jan 2026 11:32:55 +0000
Subject: [PATCH 3/4] feat: Implement construction system with building
 completion

- Add updateConstructions() function to progress building construction
- Add completeConstruction() to convert construction to actual Building
- Construction progress updates HP and displays percentage
- Completed buildings have proper attributes (HP, size, team)
- Production buildings get productionTab and canProduce flags
- Watchtower buildings get shooting capabilities (damage, range, rate)
- Add rendering for new building types in buildings.js:
  - barracks: Military barracks style with roof and windows
  - watchtower_new: Tower with platform and mounted gun
  - tank_depot: Large garage/warehouse style with tank icon
- Each building displays team color accents
---
 RECLAIM_3.4/buildings.js | 110 +++++++++++++++++++++++++++++++++++++++
 RECLAIM_3.4/game.js      |  71 +++++++++++++++++++++++++
 2 files changed, 181 insertions(+)

diff --git a/RECLAIM_3.4/buildings.js b/RECLAIM_3.4/buildings.js
index 9a59fd0..f577fa8 100644
--- a/RECLAIM_3.4/buildings.js
+++ b/RECLAIM_3.4/buildings.js
@@ -555,6 +555,116 @@
             ctx.strokeStyle = '#cbd5e1'; ctx.lineWidth = 4;
             ctx.beginPath(); ctx.moveTo(0, -45); ctx.lineTo(this.team === 'player' ? 30 : -30, -55); ctx.stroke();
         }
+        // ============================================
+        // [NEW] 플레이어 건설 건물 렌더링
+        // ============================================
+        else if (this.type === 'barracks') {
+            // 보병막사 - 군사 막사 스타일
+            const w = this.width;
+            const h = this.height;
+            const teamColor = this.team === 'player' ? '#3b82f6' : '#ef4444';
+
+            // 메인 건물
+            ctx.fillStyle = '#4b5563';
+            ctx.fillRect(-w/2, -h, w, h);
+
+            // 지붕
+            ctx.fillStyle = '#374151';
+            ctx.beginPath();
+            ctx.moveTo(-w/2 - 5, -h);
+            ctx.lineTo(0, -h - 20);
+            ctx.lineTo(w/2 + 5, -h);
+            ctx.closePath();
+            ctx.fill();
+
+            // 문
+            ctx.fillStyle = '#1f2937';
+            ctx.fillRect(-15, -40, 30, 40);
+
+            // 창문들
+            ctx.fillStyle = '#9ca3af';
+            ctx.fillRect(-w/2 + 10, -h + 15, 20, 15);
+            ctx.fillRect(w/2 - 30, -h + 15, 20, 15);
+
+            // 팀 색상 마크
+            ctx.fillStyle = teamColor;
+            ctx.fillRect(-w/2, -h, 5, h);
+            ctx.fillRect(w/2 - 5, -h, 5, h);
+        }
+        else if (this.type === 'watchtower_new') {
+            // 감시탑 - 포탑 스타일
+            const w = this.width;
+            const h = this.height;
+            const teamColor = this.team === 'player' ? '#3b82f6' : '#ef4444';
+
+            // 기둥
+            ctx.fillStyle = '#6b7280';
+            ctx.fillRect(-15, -h + 20, 30, h - 20);
+
+            // 상단 플랫폼
+            ctx.fillStyle = '#4b5563';
+            ctx.fillRect(-w/2, -h, w, 25);
+
+            // 지붕
+            ctx.fillStyle = '#374151';
+            ctx.beginPath();
+            ctx.moveTo(-w/2, -h);
+            ctx.lineTo(0, -h - 15);
+            ctx.lineTo(w/2, -h);
+            ctx.closePath();
+            ctx.fill();
+
+            // 기관총
+            ctx.fillStyle = '#1f2937';
+            ctx.fillRect(w/2 - 5, -h + 8, 25, 6);
+
+            // 팀 색상 라이트
+            ctx.fillStyle = teamColor;
+            ctx.beginPath();
+            ctx.arc(0, -h - 5, 5, 0, Math.PI * 2);
+            ctx.fill();
+        }
+        else if (this.type === 'tank_depot') {
+            // 전차기지 - 대형 창고/차고 스타일
+            const w = this.width;
+            const h = this.height;
+            const teamColor = this.team === 'player' ? '#3b82f6' : '#ef4444';
+
+            // 메인 건물 (대형)
+            ctx.fillStyle = '#374151';
+            ctx.fillRect(-w/2, -h, w, h);
+
+            // 창고 문 (큰 셔터)
+            ctx.fillStyle = '#1f2937';
+            ctx.fillRect(-w/2 + 20, -h/2, w - 40, h/2);
+
+            // 셔터 라인
+            ctx.strokeStyle = '#4b5563';
+            ctx.lineWidth = 2;
+            for (let i = 1; i < 5; i++) {
+                ctx.beginPath();
+                ctx.moveTo(-w/2 + 20, -h/2 + i * 10);
+                ctx.lineTo(w/2 - 20, -h/2 + i * 10);
+                ctx.stroke();
+            }
+
+            // 지붕
+            ctx.fillStyle = '#4b5563';
+            ctx.fillRect(-w/2 - 5, -h - 10, w + 10, 15);
+
+            // 굴뚝
+            ctx.fillStyle = '#6b7280';
+            ctx.fillRect(w/2 - 30, -h - 30, 15, 25);
+
+            // 팀 색상 표시
+            ctx.fillStyle = teamColor;
+            ctx.fillRect(-w/2, -h, w, 5);
+
+            // 탱크 아이콘 (문 위)
+            ctx.fillStyle = teamColor;
+            ctx.fillRect(-20, -h + 20, 40, 8);
+            ctx.fillRect(-10, -h + 15, 30, 5);
+        }
         ctx.restore();
         this.drawHp(ctx);
     }
diff --git a/RECLAIM_3.4/game.js b/RECLAIM_3.4/game.js
index ddc913b..4505823 100644
--- a/RECLAIM_3.4/game.js
+++ b/RECLAIM_3.4/game.js
@@ -1148,6 +1148,74 @@ const game = {
         ctx.restore();
     },
 
+    // [NEW] 건설 진행 업데이트
+    updateConstructions() {
+        if (!this.constructingBuildings) return;
+
+        const completed = [];
+
+        for (let i = this.constructingBuildings.length - 1; i >= 0; i--) {
+            const c = this.constructingBuildings[i];
+            if (c.dead) {
+                this.constructingBuildings.splice(i, 1);
+                continue;
+            }
+
+            c.progress++;
+            c.hp = Math.floor((c.progress / c.buildTime) * c.maxHp);
+
+            // 건설 완료
+            if (c.progress >= c.buildTime) {
+                completed.push(c);
+                this.constructingBuildings.splice(i, 1);
+            }
+        }
+
+        // 완료된 건물을 실제 Building으로 변환
+        for (const c of completed) {
+            this.completeConstruction(c);
+        }
+    },
+
+    // [NEW] 건설 완료 처리
+    completeConstruction(c) {
+        const bData = CONFIG.constructable[c.type];
+        if (!bData) return;
+
+        // Building 클래스 인스턴스 생성
+        const building = new Building(c.type, c.x, c.y, c.team);
+
+        // CONFIG.constructable 데이터로 오버라이드
+        building.hp = bData.hp;
+        building.maxHp = bData.hp;
+        building.width = bData.width;
+        building.height = bData.height;
+        building.isConstructed = true;  // 플레이어가 건설한 건물 표시
+
+        // 생산 가능 건물인 경우 추가 속성
+        if (bData.productionTab) {
+            building.productionTab = bData.productionTab;
+            building.canProduce = true;
+        }
+
+        // 감시탑인 경우 공격 속성 추가
+        if (bData.canShoot) {
+            building.canShoot = true;
+            building.damage = bData.damage;
+            building.range = bData.range;
+            building.rate = bData.rate;
+            building.lastAttack = 0;
+        }
+
+        this.buildings.push(building);
+
+        ui.showToast(`${bData.name} 건설 완료!`);
+
+        if (typeof AudioSystem !== 'undefined') {
+            AudioSystem.play('build_complete');
+        }
+    },
+
     // [NEW] 건설 중인 건물 렌더링
     drawConstructingBuilding(ctx, c) {
         const bData = CONFIG.constructable[c.type];
@@ -1419,6 +1487,9 @@ const game = {
         this.projectiles.forEach(p => p.update());
         this.particles.forEach(p => p.update());
 
+        // [NEW] 건설 중인 건물 업데이트
+        this.updateConstructions();
+
         this.players = this.players.filter(u => !u.dead);
         this.enemies = this.enemies.filter(u => !u.dead);
         this.projectiles = this.projectiles.filter(p => !p.dead);
-- 
2.43.0

