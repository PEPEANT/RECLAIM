From 2fa1522d50b99f2296937f17f1bc449e5d4f1217 Mon Sep 17 00:00:00 2001
From: Claude <noreply@anthropic.com>
Date: Thu, 15 Jan 2026 11:35:22 +0000
Subject: [PATCH 4/4] feat: Reorganize production system - HQ/Barracks/Depot
 separation

- Modify selectBuildingAt() to allow selection of player-built buildings
- HQ now only produces workers (infantry/armor tabs removed)
- Barracks produces infantry units when selected
- Tank depot produces armored units when selected
- Add showHQWorkerButton() for HQ-only worker production
- Add getSelectedProductionBuilding() to detect production buildings
- Add showProductionBuildingUI() for building-specific production tabs
- Add spawnFromBuilding() to spawn units near the selected building
- Buildings with canProduce flag show production UI when selected
- Each building displays its available units based on productionTab

Production flow:
1. Select HQ -> Produce workers
2. Workers build barracks/tank depot
3. Select barracks -> Produce infantry
4. Select tank depot -> Produce armor
---
 RECLAIM_3.4/game.js |  15 +++-
 RECLAIM_3.4/hud.js  | 207 +++++++++++++++++++++++++++++++++++++++++---
 2 files changed, 208 insertions(+), 14 deletions(-)

diff --git a/RECLAIM_3.4/game.js b/RECLAIM_3.4/game.js
index 4505823..202215e 100644
--- a/RECLAIM_3.4/game.js
+++ b/RECLAIM_3.4/game.js
@@ -544,11 +544,18 @@ const game = {
         let pinchAnchorClientX = 0;
         let pinchAnchorClientY = 0;
 
-        const selectHQAt = (wx, wy) => {
+        // [MODIFIED] ê±´ë¬¼ ì„ íƒ (í”Œë ˆì´ì–´ ê±´ì„¤ ê±´ë¬¼ í¬í•¨)
+        const selectBuildingAt = (wx, wy) => {
+            // ì„ íƒ ê°€ëŠ¥í•œ ê±´ë¬¼ íƒ€ì…ë“¤
+            const selectableTypes = [
+                'hq_player', 'hq_enemy', 'fortress_player', 'fortress_enemy',
+                'barracks', 'watchtower_new', 'tank_depot'  // [NEW] í”Œë ˆì´ì–´ ê±´ì„¤ ê±´ë¬¼
+            ];
+
             for (let b of this.buildings) {
                 if (b.dead) continue;
-                if (b.type !== 'hq_player' && b.type !== 'hq_enemy' &&
-                    b.type !== 'fortress_player' && b.type !== 'fortress_enemy') continue;
+                // ê¸°ì¡´ íƒ€ì… ë˜ëŠ” canProduce í”Œë˜ê·¸ê°€ ìˆëŠ” ê±´ë¬¼ë§Œ ì„ íƒ ê°€ëŠ¥
+                if (!selectableTypes.includes(b.type) && !b.canProduce && !b.canShoot) continue;
                 if (wx > b.x - b.width / 2 && wx < b.x + b.width / 2 &&
                     wy > b.y - b.height && wy < b.y) {
                     this.selectedBuilding = b;
@@ -564,6 +571,8 @@ const game = {
             this.updateHUDSelection();
             return false;
         };
+        // Alias for backward compatibility
+        const selectHQAt = selectBuildingAt;
 
         const getTouchDist = (t1, t2) => Math.hypot(t2.clientX - t1.clientX, t2.clientY - t1.clientY);
         const getTouchMid = (t1, t2) => ({
diff --git a/RECLAIM_3.4/hud.js b/RECLAIM_3.4/hud.js
index ed4962b..a2b8843 100644
--- a/RECLAIM_3.4/hud.js
+++ b/RECLAIM_3.4/hud.js
@@ -408,21 +408,22 @@ const HUD = {
             return;
         }
 
-        const shouldShowProduction =
-            this.selection &&
+        // [NEW] ê±´ë¬¼ ì„ íƒ ì‹œ í•´ë‹¹ ê±´ë¬¼ì˜ ìƒì‚° íƒ­ í‘œì‹œ
+        const selectedBuilding = this.getSelectedProductionBuilding();
+        if (selectedBuilding) {
+            this.showProductionBuildingUI(selectedBuilding, productionArea, footer, buildingLabel);
+            return;
+        }
+
+        // HQëŠ” ì‘ì—…ìë§Œ ìƒì‚° ê°€ëŠ¥ (ë³´ë³‘/ì „ì°¨ íƒ­ì€ ê±´ë¬¼ë¡œ ì´ë™)
+        const isHQ = this.selection &&
             this.selection.kind === 'building' &&
             this.selection.name === 'hq_player' &&
             this.selection.team === 'player';
 
-        if (shouldShowProduction) {
-            // Move unit panel into HUD production area
-            productionArea.innerHTML = '';
-            productionArea.appendChild(unitPanel);
-            unitPanel.style.display = 'block';
-
-            // [FIX] Add state class to footer for hiding info area and showing building label
-            if (footer) footer.classList.add('hud-show-production');
-            if (buildingLabel) buildingLabel.textContent = 'ë³¸ë¶€';
+        if (isHQ) {
+            // HQ ì„ íƒ: ì‘ì—…ì ìƒì‚° ë²„íŠ¼ë§Œ í‘œì‹œ
+            this.showHQWorkerButton(productionArea, footer, buildingLabel);
         } else {
             // Return unit panel to original location and hide
             const parent = this.elements.unitPanelOriginalParent;
@@ -535,6 +536,190 @@ const HUD = {
         return null;
     },
 
+    // [NEW] HQì—ì„œ ì‘ì—…ì ìƒì‚° ë²„íŠ¼ í‘œì‹œ
+    showHQWorkerButton(productionArea, footer, buildingLabel) {
+        if (!productionArea) return;
+
+        const workerData = CONFIG.units.worker;
+        if (!workerData) return;
+
+        productionArea.innerHTML = '';
+
+        const btnContainer = document.createElement('div');
+        btnContainer.className = 'flex gap-2 items-center';
+        btnContainer.style.cssText = 'padding: 4px;';
+
+        // ì‘ì—…ì ìƒì‚° ë²„íŠ¼
+        const btn = document.createElement('button');
+        btn.className = 'prod-btn flex flex-col items-center justify-center px-3 py-2 rounded bg-slate-700 hover:bg-slate-600 border border-slate-500 text-white text-xs transition-all';
+        btn.style.cssText = 'min-width: 80px;';
+
+        const canAfford = game.supply >= workerData.cost;
+        const inStock = (game.playerStock.worker || 0) > 0;
+        const onCooldown = (game.cooldowns.worker || 0) > 0;
+
+        if (!canAfford || !inStock || onCooldown) {
+            btn.classList.add('opacity-50', 'cursor-not-allowed');
+        }
+
+        const stockCount = game.playerStock.worker || 0;
+        btn.innerHTML = `
+            <span class="font-bold text-sm" style="color: ${workerData.color}">${workerData.name}</span>
+            <span class="text-yellow-400">${workerData.cost}ğŸ’°</span>
+            <span class="text-gray-300 text-xs">${stockCount}ëª…</span>
+        `;
+
+        btn.addEventListener('click', (e) => {
+            e.stopPropagation();
+            if (canAfford && inStock && !onCooldown) {
+                // HQì—ì„œ ì‘ì—…ì ìŠ¤í°
+                const hq = game.buildings.find(b => b.type === 'hq_player');
+                if (hq) {
+                    game.supply -= workerData.cost;
+                    game.playerStock.worker--;
+                    game.cooldowns.worker = workerData.cooldown;
+                    game.spawnUnitDirect('worker', hq.x + 60, game.groundY, 'player');
+                    ui.showToast('ì‘ì—…ì ìƒì‚°!');
+                }
+            } else if (onCooldown) {
+                ui.showToast('ì¿¨íƒ€ì„ ì¤‘!');
+            } else if (!inStock) {
+                ui.showToast('ì¬ê³  ì—†ìŒ!');
+            } else {
+                ui.showToast('ìì› ë¶€ì¡±!');
+            }
+        });
+
+        btnContainer.appendChild(btn);
+
+        // ì•ˆë‚´ í…ìŠ¤íŠ¸
+        const hint = document.createElement('span');
+        hint.className = 'text-gray-400 text-xs ml-2';
+        hint.textContent = 'ì‘ì—…ìë¡œ ê±´ë¬¼ ê±´ì„¤';
+        btnContainer.appendChild(hint);
+
+        productionArea.appendChild(btnContainer);
+
+        if (footer) footer.classList.add('hud-show-production');
+        if (buildingLabel) buildingLabel.textContent = 'ë³¸ë¶€';
+    },
+
+    // [NEW] ì„ íƒëœ ìƒì‚° ê±´ë¬¼ ê°€ì ¸ì˜¤ê¸°
+    getSelectedProductionBuilding() {
+        if (!this.selection || this.selection.kind !== 'building') return null;
+        if (!game.selectedBuilding) return null;
+
+        const b = game.selectedBuilding;
+        // canProduce í”Œë˜ê·¸ê°€ ìˆëŠ” ê±´ë¬¼ë§Œ (ë³´ë³‘ë§‰ì‚¬, ì „ì°¨ê¸°ì§€)
+        if (b.canProduce && b.productionTab && b.team === 'player') {
+            return b;
+        }
+        return null;
+    },
+
+    // [NEW] ìƒì‚° ê±´ë¬¼ UI í‘œì‹œ
+    showProductionBuildingUI(building, productionArea, footer, buildingLabel) {
+        if (!productionArea) return;
+
+        const tab = building.productionTab; // 'infantry' or 'armored'
+        const bData = CONFIG.constructable[building.type];
+        const buildingName = bData ? bData.name : building.type;
+
+        // í•´ë‹¹ íƒ­ì˜ ìœ ë‹› ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
+        const units = CONFIG.units;
+        const tabUnits = [];
+
+        for (const key in units) {
+            const u = units[key];
+            if (u.category === tab && !u.isBuilder && !u.isSkill) {
+                tabUnits.push({ key, data: u });
+            }
+        }
+
+        // ê¸°ì¡´ ë‚´ìš© ì§€ìš°ê³  ìƒì‚° ë²„íŠ¼ ìƒì„±
+        productionArea.innerHTML = '';
+
+        const btnContainer = document.createElement('div');
+        btnContainer.className = 'flex gap-2 items-center overflow-x-auto';
+        btnContainer.style.cssText = 'padding: 4px; max-width: 100%;';
+
+        for (const { key, data } of tabUnits) {
+            const btn = document.createElement('button');
+            btn.className = 'prod-btn flex flex-col items-center justify-center px-2 py-1 rounded bg-slate-700 hover:bg-slate-600 border border-slate-500 text-white text-xs transition-all';
+            btn.style.cssText = 'min-width: 60px;';
+
+            const canAfford = game.supply >= data.cost;
+            const inStock = (game.playerStock[key] || 0) > 0;
+            const onCooldown = (game.cooldowns[key] || 0) > 0;
+
+            if (!canAfford || !inStock || onCooldown) {
+                btn.classList.add('opacity-50', 'cursor-not-allowed');
+            }
+
+            const stockCount = game.playerStock[key] || 0;
+            btn.innerHTML = `
+                <span class="font-bold text-xs" style="color: ${data.color}">${data.name}</span>
+                <span class="text-yellow-400 text-[10px]">${data.cost}ğŸ’°</span>
+                <span class="text-gray-300 text-[10px]">${stockCount}ëŒ€</span>
+            `;
+
+            btn.addEventListener('click', (e) => {
+                e.stopPropagation();
+                if (canAfford && inStock && !onCooldown) {
+                    // ê±´ë¬¼ì—ì„œ ìœ ë‹› ìŠ¤í°
+                    this.spawnFromBuilding(building, key);
+                } else if (onCooldown) {
+                    ui.showToast('ì¿¨íƒ€ì„ ì¤‘!');
+                } else if (!inStock) {
+                    ui.showToast('ì¬ê³  ì—†ìŒ!');
+                } else {
+                    ui.showToast('ìì› ë¶€ì¡±!');
+                }
+            });
+
+            btnContainer.appendChild(btn);
+        }
+
+        productionArea.appendChild(btnContainer);
+
+        // ìƒíƒœ í‘œì‹œ
+        if (footer) footer.classList.add('hud-show-production');
+        if (buildingLabel) buildingLabel.textContent = buildingName;
+    },
+
+    // [NEW] ê±´ë¬¼ì—ì„œ ìœ ë‹› ìŠ¤í°
+    spawnFromBuilding(building, unitKey) {
+        const uData = CONFIG.units[unitKey];
+        if (!uData) return;
+
+        // ì¬ê³  ë° ìì› í™•ì¸
+        if ((game.playerStock[unitKey] || 0) <= 0) {
+            ui.showToast('ì¬ê³  ì—†ìŒ!');
+            return;
+        }
+        if (game.supply < uData.cost) {
+            ui.showToast('ìì› ë¶€ì¡±!');
+            return;
+        }
+        if ((game.cooldowns[unitKey] || 0) > 0) {
+            ui.showToast('ì¿¨íƒ€ì„ ì¤‘!');
+            return;
+        }
+
+        // ìì› ì†Œëª¨ ë° ì¬ê³  ê°ì†Œ
+        game.supply -= uData.cost;
+        game.playerStock[unitKey]--;
+        game.cooldowns[unitKey] = uData.cooldown;
+
+        // ê±´ë¬¼ ì˜†ì—ì„œ ìŠ¤í° (ê±´ë¬¼ ì˜¤ë¥¸ìª½ + ì•½ê°„ì˜ ì˜¤í”„ì…‹)
+        const spawnX = building.x + building.width / 2 + 30;
+        const spawnY = game.groundY;
+
+        game.spawnUnitDirect(unitKey, spawnX, spawnY, 'player');
+
+        ui.showToast(`${uData.name} ìƒì‚°!`);
+    },
+
     showBuildButtons(productionArea, footer, buildingLabel) {
         if (!productionArea) return;
 
-- 
2.43.0

