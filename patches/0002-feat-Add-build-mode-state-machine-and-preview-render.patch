From 9c76135ea88692e0802be6d7cab8d701ffb492d0 Mon Sep 17 00:00:00 2001
From: Claude <noreply@anthropic.com>
Date: Thu, 15 Jan 2026 11:31:25 +0000
Subject: [PATCH 2/4] feat: Add build mode state machine and preview rendering

- Add buildMode state object (active, type, previewX, valid, worker)
- Add builderCooldown timer for construction cooldown
- Add enterBuildMode(), cancelBuildMode(), updateBuildPreview() functions
- Add checkBuildPlacement() for collision detection with buildings
- Add handleBuildPlacement() for placement confirmation
- Add startConstruction() stub (to be completed in Commit C)
- Add drawBuildPreview() for green/red ghost preview rendering
- Add drawConstructingBuilding() for in-progress buildings
- Wire up mouse/touch events for build mode:
  - Left click: place building
  - Right click/ESC: cancel build mode
  - Mouse move: update preview position
- Add HUD build buttons when worker is selected:
  - Show barracks, watchtower, tank_depot buttons
  - Display cost and cooldown status
---
 RECLAIM_3.4/game.js | 286 +++++++++++++++++++++++++++++++++++++++++++-
 RECLAIM_3.4/hud.js  |  96 +++++++++++++++
 2 files changed, 381 insertions(+), 1 deletion(-)

diff --git a/RECLAIM_3.4/game.js b/RECLAIM_3.4/game.js
index ca58b9a..ddc913b 100644
--- a/RECLAIM_3.4/game.js
+++ b/RECLAIM_3.4/game.js
@@ -43,6 +43,19 @@ const game = {
     playerBuildings: [], enemyBuildings: [],
     selectedBuilding: null,
 
+    // ============================================
+    // [NEW] ê±´ì„¤ ëª¨ë“œ ìƒíƒœ
+    // ============================================
+    buildMode: {
+        active: false,
+        type: null,           // ê±´ì„¤í•  ê±´ë¬¼ íƒ€ì… (barracks, watchtower_new, tank_depot)
+        previewX: 0,          // í”„ë¦¬ë·° ìœ„ì¹˜ (ì›”ë“œ ì¢Œí‘œ)
+        previewY: 0,
+        valid: false,         // ë°°ì¹˜ ê°€ëŠ¥ ì—¬ë¶€
+        worker: null,         // ê±´ì„¤ ì¤‘ì¸ ì‘ì—…ì ì°¸ì¡°
+    },
+    builderCooldown: 0,       // ì‘ì—…ì ê³µìš© ì¿¨íƒ€ì„
+
     // [Queue System]
     spawnQueue: {},
     holdTimer: null, holdKey: null,
@@ -571,6 +584,11 @@ const game = {
                 cameraDrag = true;
                 cameraLastX = p.x;
             } else if (e.button === 0) {
+                // [NEW] ê±´ì„¤ ëª¨ë“œ ì¤‘ì´ë©´ ë°°ì¹˜ ì²˜ë¦¬
+                if (this.buildMode.active) {
+                    this.handleBuildPlacement(p.x + this.cameraX);
+                    return;
+                }
                 // ì¢Œí´ë¦­: íƒ€ê²ŸíŒ… ì¤‘ì´ë©´ íƒ€ê²ŸíŒ… ì²˜ë¦¬
                 if (this.targetingType) {
                     this.handleTargeting(p.x + this.cameraX, p.y);
@@ -588,6 +606,11 @@ const game = {
         window.addEventListener('mousemove', e => {
             const p = getScaledPos(e.clientX, e.clientY);
 
+            // [NEW] ê±´ì„¤ ëª¨ë“œ í”„ë¦¬ë·° ì—…ë°ì´íŠ¸
+            if (this.buildMode.active) {
+                this.updateBuildPreview(p.x + this.cameraX, p.y);
+            }
+
             // ì¹´ë©”ë¼ ë“œë˜ê·¸ (ìš°í´ë¦­)
             if (cameraDrag && !this.selectDragActive) {
                 this.cameraX -= (p.x - cameraLastX);
@@ -628,11 +651,19 @@ const game = {
             }
         });
 
-        // ìš°í´ë¦­ ë©”ë‰´ ì°¨ë‹¨ + ë“œë¡  ëª…ë ¹
+        // ìš°í´ë¦­ ë©”ë‰´ ì°¨ë‹¨ + ë“œë¡  ëª…ë ¹ + ê±´ì„¤ ì·¨ì†Œ
         this.canvas.addEventListener('contextmenu', e => {
             e.preventDefault();
             // [NEW] Block if inside HUD area
             if (isInsideHUD(e.clientY)) return;
+
+            // [NEW] ê±´ì„¤ ëª¨ë“œ ì·¨ì†Œ
+            if (this.buildMode.active) {
+                this.cancelBuildMode();
+                ui.showToast('ê±´ì„¤ ì·¨ì†Œ');
+                return;
+            }
+
             const p = getScaledPos(e.clientX, e.clientY);
             this.commandDrones(p.x + this.cameraX, p.y);
         });
@@ -664,6 +695,14 @@ const game = {
                 const p = getScaledPos(e.touches[0].clientX, e.touches[0].clientY);
                 if (p.x < 0 || p.x > this.width || p.y < 0 || p.y > this.height) return;
 
+                // [NEW] ê±´ì„¤ ëª¨ë“œ ì¤‘ì´ë©´ ë°°ì¹˜ ì²˜ë¦¬
+                if (this.buildMode.active) {
+                    this.updateBuildPreview(p.x + this.cameraX, p.y);
+                    this.handleBuildPlacement(p.x + this.cameraX);
+                    isMobileSelecting = false;
+                    return;
+                }
+
                 // íƒ€ê²ŸíŒ… ì¤‘ì´ë©´ íƒ€ê²ŸíŒ… ì²˜ë¦¬
                 if (this.targetingType) {
                     this.handleTargeting(p.x + this.cameraX, p.y);
@@ -764,6 +803,18 @@ const game = {
                 pinchActive = false;
             }
         });
+
+        // [NEW] ESC í‚¤ë¡œ ê±´ì„¤/íƒ€ê²ŸíŒ… ëª¨ë“œ ì·¨ì†Œ
+        window.addEventListener('keydown', e => {
+            if (e.key === 'Escape') {
+                if (this.buildMode.active) {
+                    this.cancelBuildMode();
+                    ui.showToast('ê±´ì„¤ ì·¨ì†Œ');
+                } else if (this.targetingType) {
+                    this.cancelTargeting();
+                }
+            }
+        });
     },
 
     setCategory(cat) {
@@ -919,6 +970,221 @@ const game = {
         document.getElementById('targeting-overlay').classList.add('hidden');
     },
 
+    // ============================================
+    // [NEW] ê±´ì„¤ ëª¨ë“œ í•¨ìˆ˜
+    // ============================================
+    enterBuildMode(buildingType, worker) {
+        if (!CONFIG.constructable[buildingType]) {
+            ui.showToast('ì•Œ ìˆ˜ ì—†ëŠ” ê±´ë¬¼ íƒ€ì…!');
+            return;
+        }
+        if (this.builderCooldown > 0) {
+            ui.showToast('ê±´ì„¤ ì¿¨íƒ€ì„ ì¤‘!');
+            return;
+        }
+        const bData = CONFIG.constructable[buildingType];
+        if (this.supply < bData.cost) {
+            ui.showToast('ìì› ë¶€ì¡±!');
+            return;
+        }
+
+        this.buildMode.active = true;
+        this.buildMode.type = buildingType;
+        this.buildMode.worker = worker;
+        this.buildMode.valid = false;
+
+        // ì·¨ì†Œ ì˜¤ë²„ë ˆì´ í‘œì‹œ
+        document.getElementById('targeting-overlay').classList.remove('hidden');
+        document.getElementById('target-msg').innerText = `${bData.name} ë°°ì¹˜ ìœ„ì¹˜ ì„ íƒ`;
+    },
+
+    cancelBuildMode() {
+        this.buildMode.active = false;
+        this.buildMode.type = null;
+        this.buildMode.worker = null;
+        this.buildMode.valid = false;
+        document.getElementById('targeting-overlay').classList.add('hidden');
+    },
+
+    updateBuildPreview(worldX, worldY) {
+        if (!this.buildMode.active) return;
+
+        const bType = this.buildMode.type;
+        const bData = CONFIG.constructable[bType];
+        if (!bData) return;
+
+        // í”„ë¦¬ë·° ìœ„ì¹˜ ì—…ë°ì´íŠ¸ (ì§€ë©´ì— ê³ ì •)
+        this.buildMode.previewX = worldX;
+        this.buildMode.previewY = this.groundY;
+
+        // ë°°ì¹˜ ê°€ëŠ¥ ì—¬ë¶€ íŒì •
+        this.buildMode.valid = this.checkBuildPlacement(worldX, bData);
+    },
+
+    checkBuildPlacement(x, bData) {
+        // 1. ë§µ ë²”ìœ„ ì²´í¬
+        const halfW = (bData.footprint?.w || bData.width) / 2;
+        if (x - halfW < 50 || x + halfW > CONFIG.mapWidth - 50) return false;
+
+        // 2. ê¸°ì¡´ ê±´ë¬¼ê³¼ ì¤‘ì²© ì²´í¬
+        for (const b of this.buildings) {
+            if (b.dead) continue;
+            const bHalfW = (b.width || 100) / 2;
+            const dist = Math.abs(b.x - x);
+            const minDist = halfW + bHalfW + 20; // ì—¬ìœ  ê°„ê²©
+            if (dist < minDist) return false;
+        }
+
+        // 3. ê±´ì„¤ ì¤‘ì¸ ê±´ë¬¼ê³¼ë„ ì¤‘ì²© ì²´í¬
+        if (this.constructingBuildings) {
+            for (const cb of this.constructingBuildings) {
+                if (cb.dead) continue;
+                const cbHalfW = (cb.width || 100) / 2;
+                const dist = Math.abs(cb.x - x);
+                const minDist = halfW + cbHalfW + 20;
+                if (dist < minDist) return false;
+            }
+        }
+
+        return true;
+    },
+
+    handleBuildPlacement(worldX) {
+        if (!this.buildMode.active) return;
+
+        const bType = this.buildMode.type;
+        const bData = CONFIG.constructable[bType];
+        if (!bData) return;
+
+        // ìœ íš¨ì„± ì¬í™•ì¸
+        if (!this.checkBuildPlacement(worldX, bData)) {
+            ui.showToast('ì´ ìœ„ì¹˜ì— ê±´ì„¤í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
+            return;
+        }
+
+        // ìì› ì†Œëª¨
+        if (this.supply < bData.cost) {
+            ui.showToast('ìì› ë¶€ì¡±!');
+            this.cancelBuildMode();
+            return;
+        }
+        this.supply -= bData.cost;
+
+        // ê±´ì„¤ ì¤‘ ê±´ë¬¼ ìƒì„± (Commit Cì—ì„œ êµ¬í˜„)
+        this.startConstruction(bType, worldX, this.groundY, 'player');
+
+        // ì¿¨íƒ€ì„ ì‹œì‘
+        this.builderCooldown = bData.cooldown || 120;
+
+        // ê±´ì„¤ ëª¨ë“œ ì¢…ë£Œ
+        this.cancelBuildMode();
+
+        ui.showToast(`${bData.name} ê±´ì„¤ ì‹œì‘!`);
+
+        if (typeof app !== 'undefined') {
+            app.markDirty();
+            app.markUiDirty();
+        }
+    },
+
+    // ê±´ì„¤ ì‹œì‘ (Commit Cì—ì„œ ì™„ì „ êµ¬í˜„)
+    startConstruction(bType, x, y, team) {
+        // ì„ì‹œ: ë°”ë¡œ ì™„ì„±ëœ ê±´ë¬¼ ìƒì„± (Commit Cì—ì„œ ê±´ì„¤ ì¤‘ ìƒíƒœë¡œ ë³€ê²½)
+        if (!this.constructingBuildings) this.constructingBuildings = [];
+
+        const bData = CONFIG.constructable[bType];
+        const construction = {
+            type: bType,
+            x: x,
+            y: y,
+            team: team,
+            width: bData.width,
+            height: bData.height,
+            hp: 1,
+            maxHp: bData.hp,
+            progress: 0,
+            buildTime: bData.buildTime,
+            dead: false,
+            isConstruction: true,
+        };
+        this.constructingBuildings.push(construction);
+    },
+
+    // [NEW] ê±´ì„¤ í”„ë¦¬ë·° ë Œë”ë§
+    drawBuildPreview(ctx) {
+        const bType = this.buildMode.type;
+        const bData = CONFIG.constructable[bType];
+        if (!bData) return;
+
+        const x = this.buildMode.previewX;
+        const y = this.groundY;
+        const w = bData.width;
+        const h = bData.height;
+
+        ctx.save();
+
+        // ìœ íš¨/ë¬´íš¨ì— ë”°ë¥¸ ìƒ‰ìƒ
+        const isValid = this.buildMode.valid;
+        const fillColor = isValid ? 'rgba(34, 197, 94, 0.4)' : 'rgba(239, 68, 68, 0.4)';
+        const strokeColor = isValid ? '#22c55e' : '#ef4444';
+
+        // ê±´ë¬¼ í”„ë¦¬ë·° (ë°˜íˆ¬ëª…)
+        ctx.fillStyle = fillColor;
+        ctx.fillRect(x - w / 2, y - h, w, h);
+
+        // í…Œë‘ë¦¬ (ì ì„ )
+        ctx.strokeStyle = strokeColor;
+        ctx.lineWidth = 2;
+        ctx.setLineDash([8, 4]);
+        ctx.strokeRect(x - w / 2, y - h, w, h);
+
+        // ê±´ë¬¼ ì´ë¦„ í‘œì‹œ
+        ctx.setLineDash([]);
+        ctx.fillStyle = strokeColor;
+        ctx.font = 'bold 14px sans-serif';
+        ctx.textAlign = 'center';
+        ctx.fillText(bData.name, x, y - h - 8);
+
+        ctx.restore();
+    },
+
+    // [NEW] ê±´ì„¤ ì¤‘ì¸ ê±´ë¬¼ ë Œë”ë§
+    drawConstructingBuilding(ctx, c) {
+        const bData = CONFIG.constructable[c.type];
+        if (!bData) return;
+
+        const x = c.x;
+        const y = c.y;
+        const w = c.width;
+        const h = c.height;
+
+        ctx.save();
+
+        // ê±´ì„¤ ì¤‘ ë°°ê²½ (íšŒìƒ‰)
+        ctx.fillStyle = '#374151';
+        ctx.fillRect(x - w / 2, y - h, w, h);
+
+        // ì§„í–‰ë¥ ì— ë”°ë¥¸ ì±„ì›Œì§ (ì•„ë˜ì—ì„œ ìœ„ë¡œ)
+        const progress = c.progress / c.buildTime;
+        const fillH = h * progress;
+        ctx.fillStyle = '#3b82f6';
+        ctx.fillRect(x - w / 2, y - fillH, w, fillH);
+
+        // í…Œë‘ë¦¬
+        ctx.strokeStyle = '#60a5fa';
+        ctx.lineWidth = 2;
+        ctx.strokeRect(x - w / 2, y - h, w, h);
+
+        // ì§„í–‰ë¥  í…ìŠ¤íŠ¸
+        ctx.fillStyle = '#fff';
+        ctx.font = 'bold 12px sans-serif';
+        ctx.textAlign = 'center';
+        ctx.fillText(`${Math.floor(progress * 100)}%`, x, y - h / 2);
+        ctx.fillText(bData.name, x, y - h - 5);
+
+        ctx.restore();
+    },
+
     commandDrones(x, y) {
         let count = 0;
         this.players.forEach(u => {
@@ -1126,6 +1392,10 @@ const game = {
 
         for (let k in this.cooldowns) if (this.cooldowns[k] > 0) this.cooldowns[k]--;
         for (let k in this.enemyCooldowns) if (this.enemyCooldowns[k] > 0) this.enemyCooldowns[k]--;
+
+        // [NEW] ì‘ì—…ì ê±´ì„¤ ì¿¨íƒ€ì„ ê°ì†Œ
+        if (this.builderCooldown > 0) this.builderCooldown--;
+
         if (this.empTimer > 0) {
             this.empTimer--;
             document.getElementById('emp-flash').classList.toggle('active', this.empTimer > 0);
@@ -1240,6 +1510,20 @@ const game = {
         this.players.forEach(u => u.draw(ctx));
         this.projectiles.forEach(p => p.draw(ctx));
         this.particles.forEach(p => p.draw(ctx));
+
+        // [NEW] ê±´ì„¤ ì¤‘ì¸ ê±´ë¬¼ ë Œë”ë§
+        if (this.constructingBuildings) {
+            this.constructingBuildings.forEach(c => {
+                if (c.dead) return;
+                this.drawConstructingBuilding(ctx, c);
+            });
+        }
+
+        // [NEW] ê±´ì„¤ í”„ë¦¬ë·° ë Œë”ë§
+        if (this.buildMode.active && this.buildMode.type) {
+            this.drawBuildPreview(ctx);
+        }
+
         ctx.restore();
 
         // [VFX] screen flash (screen-space) - í°ìƒ‰ë§Œ ì‚¬ìš©
diff --git a/RECLAIM_3.4/hud.js b/RECLAIM_3.4/hud.js
index 8b5443c..ed4962b 100644
--- a/RECLAIM_3.4/hud.js
+++ b/RECLAIM_3.4/hud.js
@@ -401,6 +401,13 @@ const HUD = {
         const buildingLabel = this.elements.buildingLabel;
         if (!productionArea || !unitPanel) return;
 
+        // [NEW] ì‘ì—…ì ì„ íƒ ì‹œ ê±´ë¬¼ ë²„íŠ¼ í‘œì‹œ
+        const hasWorkerSelected = this.checkWorkerSelected();
+        if (hasWorkerSelected) {
+            this.showBuildButtons(productionArea, footer, buildingLabel);
+            return;
+        }
+
         const shouldShowProduction =
             this.selection &&
             this.selection.kind === 'building' &&
@@ -505,6 +512,95 @@ const HUD = {
         ctx.strokeRect(cx, 0, cw, cvs.height);
     },
 
+    // ============================================
+    // [NEW] ì‘ì—…ì ê±´ì„¤ ë²„íŠ¼ ê´€ë ¨ í•¨ìˆ˜
+    // ============================================
+    checkWorkerSelected() {
+        if (!game.selectedUnits || game.selectedUnits.size === 0) return false;
+        for (const u of game.selectedUnits) {
+            if (u.stats && u.stats.isBuilder && u.team === 'player' && !u.dead) {
+                return true;
+            }
+        }
+        return false;
+    },
+
+    getSelectedWorker() {
+        if (!game.selectedUnits) return null;
+        for (const u of game.selectedUnits) {
+            if (u.stats && u.stats.isBuilder && u.team === 'player' && !u.dead) {
+                return u;
+            }
+        }
+        return null;
+    },
+
+    showBuildButtons(productionArea, footer, buildingLabel) {
+        if (!productionArea) return;
+
+        // ê±´ì„¤ ê°€ëŠ¥í•œ ê±´ë¬¼ ëª©ë¡
+        const buildings = CONFIG.constructable || {};
+        const worker = this.getSelectedWorker();
+
+        // ê¸°ì¡´ ë‚´ìš© ì§€ìš°ê³  ê±´ë¬¼ ë²„íŠ¼ ìƒì„±
+        productionArea.innerHTML = '';
+
+        const btnContainer = document.createElement('div');
+        btnContainer.className = 'flex gap-2 items-center';
+        btnContainer.style.cssText = 'padding: 4px;';
+
+        for (const key in buildings) {
+            const bData = buildings[key];
+
+            const btn = document.createElement('button');
+            btn.className = 'build-btn flex flex-col items-center justify-center px-3 py-2 rounded bg-slate-700 hover:bg-slate-600 border border-slate-500 text-white text-xs transition-all';
+            btn.style.cssText = 'min-width: 70px;';
+
+            const canAfford = game.supply >= bData.cost;
+            const onCooldown = game.builderCooldown > 0;
+
+            if (!canAfford || onCooldown) {
+                btn.classList.add('opacity-50', 'cursor-not-allowed');
+            }
+
+            btn.innerHTML = `
+                <span class="font-bold text-sm">${bData.name}</span>
+                <span class="text-yellow-400">${bData.cost} ğŸ’°</span>
+            `;
+
+            btn.addEventListener('click', (e) => {
+                e.stopPropagation();
+                if (worker && canAfford && !onCooldown) {
+                    game.enterBuildMode(key, worker);
+                } else if (onCooldown) {
+                    ui.showToast('ê±´ì„¤ ì¿¨íƒ€ì„ ì¤‘!');
+                } else if (!canAfford) {
+                    ui.showToast('ìì› ë¶€ì¡±!');
+                }
+            });
+
+            btnContainer.appendChild(btn);
+        }
+
+        // ì·¨ì†Œ ë²„íŠ¼ (ê±´ì„¤ ëª¨ë“œ ì¤‘ì¼ ë•Œë§Œ)
+        if (game.buildMode && game.buildMode.active) {
+            const cancelBtn = document.createElement('button');
+            cancelBtn.className = 'px-3 py-2 rounded bg-red-600 hover:bg-red-500 text-white text-xs font-bold';
+            cancelBtn.innerText = 'ì·¨ì†Œ';
+            cancelBtn.addEventListener('click', (e) => {
+                e.stopPropagation();
+                game.cancelBuildMode();
+            });
+            btnContainer.appendChild(cancelBtn);
+        }
+
+        productionArea.appendChild(btnContainer);
+
+        // ìƒíƒœ í‘œì‹œ
+        if (footer) footer.classList.add('hud-show-production');
+        if (buildingLabel) buildingLabel.textContent = 'ì‘ì—…ì - ê±´ì„¤';
+    },
+
     /**
      * Hide legacy UI elements (replaced by new HUD)
      */
-- 
2.43.0

